name: Auto-Tag-and-Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  autotag:
    name: Auto Tag Version
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: tag
        run: |
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "last_tag=$last_tag"
          
          base=${last_tag#v}
          major=$(echo $base | cut -d. -f1)
          minor=$(echo $base | cut -d. -f2)
          patch=$(echo $base | cut -d. -f3)

          new_patch=$((patch + 1))
          new_tag="v$major.$minor.$new_patch"

          git tag "$new_tag"
          git push origin "$new_tag"

          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

  build:
    name: Build 3OS
    runs-on: ${{ matrix.os }}
    needs: autotag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create dist
        run: mkdir -p dist

      - name: Build placeholder
        run: |
          echo "GC-Control runtime for ${{ matrix.os }}" > dist/runtime_${{ matrix.os }}.txt

      - name: Generate SHA256 (Linux/Mac)
        if: runner.os != 'Windows'
        run: |
          cd dist
          for f in *; do
            sha256sum "$f" >> SHA256_PROOF.txt
          done

      - name: Generate SHA256 (Windows)
        if: runner.os == 'Windows'
        run: |
          cd dist
          powershell -Command "Get-ChildItem | ForEach-Object { $h = Get-FileHash -Algorithm SHA256 $_; Write-Output ($h.Hash + '  ' + $_.Name) }" | Out-File -Encoding ascii SHA256_PROOF.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GC-${{ matrix.os }}
          path: dist/

  release:
    name: Create Release
    needs: [build, autotag]
    runs-on: ubuntu-latest
    if: needs.autotag.outputs.new_tag != ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Zip Release Assets
        run: |
          cd release_assets
          for d in *; do
            zip -r "${d}.zip" "$d"
          done

      - name: Generate ProofLedger
        run: |
          echo "Language-Control-the-GC-process" > PROOF_LEDGER.txt
          echo "Tag: ${{ needs.autotag.outputs.new_tag }}" >> PROOF_LEDGER.txt
          echo "Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> PROOF_LEDGER.txt
          echo "Commit: $GITHUB_SHA" >> PROOF_LEDGER.txt
          echo "" >> PROOF_LEDGER.txt
          echo "Artifacts:" >> PROOF_LEDGER.txt
          ls release_assets >> PROOF_LEDGER.txt

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.autotag.outputs.new_tag }}
          files: |
            release_assets/*.zip
            PROOF_LEDGER.txt
